"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.processDebuggingFiles = exports.generateBundleId = exports.addBundleId = void 0;
/*
 * Copyright (c) 2025 Amazon.com, Inc. or its affiliates.  All rights reserved.
 *
 * PROPRIETARY/CONFIDENTIAL.  USE IS SUBJECT TO LICENSE TERMS.
 */
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const crypto_1 = __importDefault(require("crypto"));
const log_1 = __importDefault(require("./log"));
async function processDebuggingFiles(bundlePath, sourcemapPath) {
    try {
        const bundleDir = path_1.default.dirname(bundlePath);
        const sourcemapDir = path_1.default.dirname(sourcemapPath);
        // Calculate bundle_id
        const bundleId = await generateBundleId(bundlePath);
        // Rename bundle and source map files
        const newBundleName = `${bundleId}.bundle`;
        const newSourcemapName = `${bundleId}.bundle.map`;
        const newBundlePath = path_1.default.join(bundleDir, newBundleName);
        const newSourcemapPath = path_1.default.join(sourcemapDir, newSourcemapName);
        fs_1.default.copyFileSync(bundlePath, newBundlePath);
        fs_1.default.copyFileSync(sourcemapPath, newSourcemapPath);
        // Modify sourcemap to add hash as value of x_amazon_bundleId property
        addBundleId(newSourcemapPath, bundleId);
        return { newBundlePath, newSourcemapPath };
    }
    catch (error) {
        log_1.default.error('Error processing debugging files:', error);
        // If any error occurs, return the original paths
        return { newBundlePath: bundlePath, newSourcemapPath: sourcemapPath };
    }
}
exports.processDebuggingFiles = processDebuggingFiles;
async function generateBundleId(bundlePath) {
    return new Promise((resolve, reject) => {
        const hash = crypto_1.default.createHash('sha256');
        const stream = fs_1.default.createReadStream(bundlePath);
        stream.on('data', (data) => hash.update(data));
        stream.on('end', () => resolve(hash.digest('hex')));
        stream.on('error', reject);
    });
}
exports.generateBundleId = generateBundleId;
function addBundleId(sourcemapPath, bundleId) {
    const sourcemap = JSON.parse(fs_1.default.readFileSync(sourcemapPath, 'utf8'));
    sourcemap.x_amazon_bundleId = bundleId;
    fs_1.default.writeFileSync(sourcemapPath, JSON.stringify(sourcemap));
}
exports.addBundleId = addBundleId;

#!/usr/bin/env python3

import argparse
import bisect
import difflib
import os
import json
import sys

class LogColors:
    COLOR_OFF = '\033[0m'
    COLOR_CYAN = '\033[0;36m'
    # Bold
    COLOR_B_YELLOW = '\033[1;33m'

class JSSourceDescriptor:
    def __init__(self, source_path, system_bundle_source):
        self.source_path = source_path
        self.system_bundle_source = system_bundle_source
        self.base_source_path = source_path.split("node_modules")[1]

def logHighlightedInfo(*args):
    message = ' '.join(str(arg) for arg in args)
    print(f"{LogColors.COLOR_CYAN}{message}{LogColors.COLOR_OFF}")

def logWarn(*args):
    message = ' '.join(str(arg) for arg in args)
    print(f"{LogColors.COLOR_B_YELLOW}{message}{LogColors.COLOR_OFF}")

def logInfo(*args):
    message = ' '.join(str(arg) for arg in args)
    print(f"{message}")

def get_source(sorted_list, base_path):
    class KeyWrapper:
        def __init__(self, item, key):
            self.item = item
            self.key = key

        def __lt__(self, other):
            return self.key < other

    # Wrap each item with its comparison key
    wrapped_list = [KeyWrapper(item, item.base_source_path) for item in sorted_list]

    # Find the insertion point
    i = bisect.bisect_left(wrapped_list, base_path)

    # Check if we found a matching item
    if i != len(sorted_list) and sorted_list[i].base_source_path == base_path:
        return sorted_list[i]
    return None


def unified_diff(string1, string2):
    diff = difflib.unified_diff(
        string1.splitlines(keepends=True),
        string2.splitlines(keepends=True),
        fromfile="string1",
        tofile="string2",
    )
    return "".join(diff)

if __name__ == "__main__":
    description = """
    Given a system bundle map file and a full app bundle map file,
    this tool will compare the sources in the system bundle to what is
    in the full app bundle and report differences.
    """

    epilog = """
    Differences are reported with a unified diff.
    
    Finding differences does not necessarily mean there is a problem,
    but differences should be investigated. If a system bundle is not
    executing properly, this may be helpful at identifying the problem.
    For example, build differences could occur due to use of Babel plugins 
    that are not accounted for in the build of the system bundle.
    """

    parser = argparse.ArgumentParser(description=description, epilog=epilog, formatter_class=argparse.RawDescriptionHelpFormatter)
    parser.add_argument(
        "filepath_system_bundle_map",
        type=str,
        help="filepath of system bundle map file",
    )
    parser.add_argument(
        "filepath_app_bundle_map",
        type=str,
        help="filepath of application bundle map file",
    )
    parser.add_argument(
        "library_name", type=str, help="name of the system library JavaScript package (e.g. @amazon-devices/react-native-kepler)"
    )
    parser.add_argument("executable_name", type=str, help="name of the app executable (e.g. kitchensinkapp)")

    args = parser.parse_args()

    with open(args.filepath_system_bundle_map, "r") as f:
        system_bundle_map = json.load(f)

    with open(args.filepath_app_bundle_map, "r") as f:
        app_bundle_map = json.load(f)

    # Create a list of JSSourceIdentifier
    bundle_sources = []

    for index, path in enumerate(system_bundle_map["sources"]):
        if "node_modules" in path:
            system_bundle_source = system_bundle_map["sourcesContent"][index]
            sourceID = JSSourceDescriptor(path, system_bundle_source)
            bundle_sources.append(sourceID)

    bundle_sources.sort(key=lambda x: x.base_source_path)

    pathsDone = 0
    differences_found = 0

    logHighlightedInfo(
        "Comparing system bundle source for %s with app bundle source of %s."
        % (args.library_name, args.executable_name)
    )

    for index, path in enumerate(app_bundle_map["sources"]):
        if "node_modules" in path:
            base_path = path.split("node_modules")[1]
            source_desc = get_source(bundle_sources, base_path)
            if source_desc is not None:
                pathsDone += 1
                # Diff the app source with system bundle source
                app_source = app_bundle_map["sourcesContent"][index]
                diff = unified_diff(source_desc.system_bundle_source, app_source)
                if diff:
                    differences_found += 1
                    logWarn(
                        "Warning: Differences at path %s:"
                        % (source_desc.base_source_path)
                    )
                    print(diff)

    logHighlightedInfo(
        "Compared %d system bundle source files with app bundle source. %d had differences" % (pathsDone, differences_found)
    )

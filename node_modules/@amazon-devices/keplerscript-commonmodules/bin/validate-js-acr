#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

// Constants
const SYSTEM_ACR_TRACE_END_MARKER = '</non_native_stack_trace>';

// ANSI color codes
const colors = {
    boldGreen: '\x1b[1;32m',
    green: '\x1b[0;32m',
    none: '\x1b[0m',
    boldRed: '\x1b[1;31m',
    red: '\x1b[0;31m',
    bold: '\x1b[1m'
};

function validateJsAcr(acrPath) {
    const acrName = path.basename(acrPath);

    if (fs.existsSync(acrPath)) {
        console.log(`Verifying ${acrName}`);

        const fileContent = fs.readFileSync(acrPath, 'utf8');
        const lines = fileContent.split('\n');
        let lastLine = '';

        for (const line of lines) {
            // Skip empty lines
            if (!line.trim()) continue;

            if (line === SYSTEM_ACR_TRACE_END_MARKER) {
                console.log('Found JS stack trace');
                console.log(`Last line: ${lastLine}`);

                if (lastLine.includes('(node_modules/')) {
                    console.log(`${colors.boldGreen}PASS${colors.green} - ACR JavaScript stack trace starts with node_modules.${colors.none}`);
                    return 0;
                } else if (lastLine.includes('index.bundle')) {
                    console.log(`${colors.boldGreen}PASS${colors.green} - ACR JavaScript stack trace contains index.bundle.${colors.none}`);
                    return 0;
                } else if (lastLine.includes('hash.bundle')) {
                    console.log(`${colors.boldGreen}PASS${colors.green} - ACR JavaScript stack trace contains hash.bundle.${colors.none}`);
                    return 0;
                } else {
                    console.log(`${colors.boldRed}FAIL${colors.red} - ACR JavaScript stack trace does not start with node_modules, nor contain index.bundle or hash.bundle.${colors.none}`);
                    return 1;
                }
            }
            lastLine = line;
        }
    } else {
        console.log(`${colors.boldRed}FAIL${colors.red} - File not found at ${acrPath}`);
        return 1;
    }
}

function printUsage() {
    console.log(`${colors.bold}NAME${colors.none}`);
    console.log(`     ${colors.bold}validate_js_acr${colors.none} - given a path to an Amazon Crash Report (ACR) file with a JavaScript crash, verify the JavaScript stack is symbolicated as expected.`);
    console.log('');
    console.log(`${colors.bold}SYNOPSIS${colors.none}`);
    console.log(`     ${colors.bold}validate_js_acr${colors.none} <file path>`);
    console.log('');
    console.log(`${colors.bold}DESCRIPTION${colors.none}`);
    console.log('     The stack is interpreted as symbolicated if the source path begins with node_modules, or contains either index.bundle or hash.bundle.');
    console.log('');
    process.exit(1);
}

// Main execution
const acrPath = process.argv[2];

if (!acrPath) {
    printUsage();
} else {
    process.exit(validateJsAcr(acrPath));
}

"use strict";
/**
 * Copyright (c) 2024 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * PROPRIETARY/CONFIDENTIAL
 *
 * Use is subject to license terms.
 *
 */
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const RNCodegenUtils_1 = require("./RNCodegenUtils");
const KeplerCodegen_1 = require("./generators/KeplerCodegen");
const parser = new RNCodegenUtils_1.TypeScriptParser();
const KeplerCodegen = ({ path: tsPath, outputPath, namespace: cxxnamespace, n: overwrite, outFile, classname, }) => {
    console.log('[KeplerCodegen] Codegen called');
    console.log('[KeplerCodegen] TS interface:', tsPath);
    console.log('[KeplerCodegen] Ouput path:', outputPath);
    console.log('[KeplerCodegen] Generating implementation templates:', overwrite);
    // Step 1 - Run parser
    const schema = parser.parseFile(tsPath);
    console.log('[KeplerCodegen] Parsing complete');
    // Step 2 - Run generators
    const metadata = {
        cxxnamespace,
        filePrefix: outFile,
        classname,
    };
    const generated = (0, KeplerCodegen_1.generateKeplerCode)(metadata, schema);
    console.log('[KeplerCodegen] Generation complete, writing files');
    // Step 3 - Write files
    const generatedCodePath = path.join(outputPath, 'generated');
    fs.mkdirSync(generatedCodePath, { recursive: true });
    generated.forEach((generatedFile) => {
        if (generatedFile.alwaysWrite) { // Write spec files
            fs.writeFileSync(path.join(generatedCodePath, generatedFile.filename), generatedFile.contents);
            console.log(`[KeplerCodegen] Wrote Spec file ${generatedFile.filename}`);
        }
        else if (overwrite) { // Write implementation templates
            const implFilePath = path.join(outputPath, generatedFile.filename);
            // Make a .bak if file exists
            if (fs.existsSync(implFilePath)) {
                fs.renameSync(implFilePath, `${implFilePath}.bak`);
                console.log(`[KeplerCodegen] Backed up existing file to ${generatedFile.filename}.bak`);
            }
            fs.writeFileSync(implFilePath, generatedFile.contents);
            console.log(`[KeplerCodegen] Wrote Impl file ${generatedFile.filename}`);
        }
        else {
            console.log(`[KeplerCodegen] Not writing ${generatedFile.filename}, not requested`);
        }
    });
    console.log('[KeplerCodegen] Finished!');
};
exports.default = KeplerCodegen;

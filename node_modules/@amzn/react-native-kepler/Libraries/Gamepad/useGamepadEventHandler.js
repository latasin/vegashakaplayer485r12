/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * Portions of this file are copyright (c) 2025 - Amazon.com, Inc. or its affiliates.  All rights reserved.
 *
 * PORTIONS OF THIS FILE ARE AMAZON PROPRIETARY/CONFIDENTIAL.  USE IS SUBJECT TO LICENSE TERMS.
 *
 * Amazon modifications are indicated by [amznmod_* comments].
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * @format
 * @flow
 */


import React, { useEffect, useRef, useState, useCallback } from 'react';
import type { GamepadEvent, GamepadEventSubscription, SetGamepadSubscriptionState } from './GamepadTypes';
import type { EventSubscription } from '../vendor/emitter/EventEmitter';
import { useAddGamepadEventListenerCallback } from '../UserInputManager/UserInputManager';


const useGamepadEventHandler = (
  handleEvent: (evt: GamepadEvent) => void,
): GamepadEventSubscription => {

  const addGamepadEventListenerCallback = useAddGamepadEventListenerCallback();
  const subscriptionRef: EventSubscription | null = useRef(null);
  const [enabled, setEnabled] = useState(true);

  useEffect(() => {

    // The `enabled` flag indicates whether the callback passed to `useGamepadEventHandler` is currently active (i.e., registered on the native side).
    // It will be `true` if the subscription is active, and `false` otherwise. The user can dynamically enable or disable the callback using the 
    // `setEnabled` method returned by the hook. Passing `true` enables the subscription; passing `false` disables it.
    //
    // Internally, enabling the callback registers the subscription in `eventSubscriptionGamepadEventVendor_` within `UserInputManager.cpp` via a 
    // TurboModule-exposed method. Disabling it removes the associated `EventSubscriptionV2` object from that vendor list.
    //
    // This mechanism allows developers to dynamically manage gamepad input subscriptions from JavaScript, improving flexibility and user experience.

    if (enabled && !subscriptionRef.current) {
      subscriptionRef.current = addGamepadEventListenerCallback(handleEvent);
    } else if (!enabled && subscriptionRef.current) {
      subscriptionRef.current.remove();
      subscriptionRef.current = null;
    }
  }, [enabled, handleEvent, addGamepadEventListenerCallback]);

  const toggleEnabled: SetGamepadSubscriptionState = useCallback((value: boolean) => {
    setEnabled(value);
  }, []);

  return { enabled, setEnabled: toggleEnabled };
};

module.exports = useGamepadEventHandler;

/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * Portions of this file are copyright (c) 2021-2024 Amazon.com, Inc. or its affiliates.  All rights reserved.
 *
 * PORTIONS OF THIS FILE ARE AMAZON PROPRIETARY/CONFIDENTIAL.  USE IS SUBJECT TO LICENSE TERMS.
 *
 * Amazon modifications are indicated by [amznmod_* comments].
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * @format
 */

/**
 * CHANGELOG:
 */

'use strict';

const MockNativeMethods = jest.requireActual('./MockNativeMethods');
const mockComponent = jest.requireActual('./mockComponent');

jest.requireActual('@react-native/js-polyfills/Object.es8');
jest.requireActual('@react-native/js-polyfills/error-guard');

global.__DEV__ = true;

global.performance = {
  now: jest.fn(Date.now),
};

global.regeneratorRuntime = jest.requireActual('regenerator-runtime/runtime');
global.window = global;

global.requestAnimationFrame = function (callback) {
  return setTimeout(() => callback(jest.now()), 0);
};
global.cancelAnimationFrame = function (id) {
  clearTimeout(id);
};
// amznmod_react - Extract commonly used Dimensions to be placed in multiple mocks
const mockDimensions = () => {
  return {
    Dimensions: {
      windows: [{
        fontScale: 2,
        height: 1334,
        scale: 2,
        width: 750,
        moduleName: 'jest',
      }],
      window: {
        fontScale: 2,
        height: 1334,
        scale: 2,
        width: 750,
      },
      screen: {
        fontScale: 2,
        height: 1334,
        scale: 2,
        width: 750,
      },
      physical: {
        fontScale: 2,
        height: 1334,
        scale: 2,
        width: 750,
      },
    },
  }
};

// there's a __mock__ for it.
jest.setMock(
  '../Libraries/vendor/core/ErrorUtils',
  require('../Libraries/vendor/core/ErrorUtils'),
);

// amznmod_react - Mock APIs for changes on system locale and timezone config
jest
  .mock('../Libraries/Core/InitializeCore', () => {})
  .mock('../Libraries/Core/NativeExceptionsManager', () => ({
    __esModule: true,
    default: {
      reportException: jest.fn(),
    },
  }))
    .mock('../Libraries/AlexaManager/spec/AlexaManagerSpec', () => ({
      start: jest.fn(),
      stop: jest.fn(),
      registerDirectiveListener: jest.fn(),
      registerStateProvider: jest.fn(),
      unregisterStateProvider: jest.fn(),
      sendResponse: jest.fn(),
      sendDeferredResponse: jest.fn(),
      sendErrorResponse: jest.fn(),
      reportStateChange: jest.fn(),
      setCapabilities: jest.fn(),
      sendAvsEvent: jest.fn()
    }))
  // amznmod_react - Mock the TurboModuleRegistry
  .mock('../Libraries/TurboModule/TurboModuleRegistry', () => {
      return {
          getEnforcing: jest.fn(),
          get: jest.fn(),
      };
  })
  // amznmod_react - Mock the styles
  .mock('../Libraries/StyleSheet/StyleSheet', () => {
      return {
        create: (styleObj: Object) => ({...styleObj}),
        compose: (style1: Object, style2: Object) => ({...style1, ...style2}),
        flatten: (style) => {
            const flattenStyle = require('react-native/Libraries/StyleSheet/flattenStyle');
            return flattenStyle(style);
        },
      };
  })
  // amznmod_react - Mock the TV event handler
  .mock('../Libraries/TV/useTVEventHandler', () => {
    return jest.fn();
  })
  .mock('../Libraries/Gamepad/useGamepadEventHandler', () => {
    return jest.fn(() => ({
      enabled: true,
      setEnabled: jest.fn(),
    }));
  })
  .mock('../Libraries/Network/useServerChallengeReceived', () => ({
    useServerChallengeReceived: jest.fn(() => ({ isChallengeReceived: 10, setAuthCert: jest.fn(), challengeUrl: "" })),
  }))
  // amznmod_react - Mock the KeplerBackHandler
  .mock('../Libraries/Utilities/KeplerBackHandler', () => ({
    useKeplerBackHandler: jest.fn(() => ({ addEventListener: jest.fn(), removeEventListener: jest.fn(), exitApp: jest.fn() })),
  }))
  // amznmod_react - Mock the UI Manager
  .mock('../Libraries/ReactNative/UIManager', () => ({
    AndroidViewPager: {
      Commands: {
        setPage: jest.fn(),
        setPageWithoutAnimation: jest.fn(),
      },
    },
    blur: jest.fn(),
    createView: jest.fn(),
    customBubblingEventTypes: {},
    customDirectEventTypes: {},
    dispatchViewManagerCommand: jest.fn(),
    focus: jest.fn(),
    getViewManagerConfig: jest.fn(name => {
      if (name === 'AndroidDrawerLayout') {
        return {
          Constants: {
            DrawerPosition: {
              Left: 10,
            },
          },
        };
      }
    }),
    hasViewManagerConfig: jest.fn(name => {
      return name === 'AndroidDrawerLayout';
    }),
    measure: jest.fn(),
    manageChildren: jest.fn(),
    removeSubviewsFromContainerWithID: jest.fn(),
    replaceExistingNonRootView: jest.fn(),
    setChildren: jest.fn(),
    updateView: jest.fn(),
    AndroidDrawerLayout: {
      Constants: {
        DrawerPosition: {
          Left: 10,
        },
      },
    },
    AndroidTextInput: {
      Commands: {},
    },
    ScrollView: {
      Constants: {},
    },
    View: {
      Constants: {},
    },
  }))
  .mock('../Libraries/Image/Image', () =>
    mockComponent('../Libraries/Image/Image'),
  )
  .mock('../Libraries/Text/Text', () =>
    mockComponent('../Libraries/Text/Text', MockNativeMethods),
  )
  .mock('../Libraries/Components/TextInput/TextInput', () =>
    mockComponent('../Libraries/Components/TextInput/TextInput', {
      ...MockNativeMethods,
      isFocused: jest.fn(),
      clear: jest.fn(),
      getNativeRef: jest.fn(),
    }),
  )
  .mock('../Libraries/Modal/Modal', () => {
      const React = require('react');
      const Component = class extends React.Component {
        render() {
          return React.createElement('Modal', this.props, this.props.children);
        }
      };

      Component.displayName = 'Modal';

      return Component;
  })
  // amznmod_react - Mock register Generated View Config
  .mock('../Libraries/Utilities/registerGeneratedViewConfig', () => ({
      __esModule: true,
      default: jest.fn((componentName, partialViewConfig) => partialViewConfig),
      register: jest.fn((componentName, partialViewConfig) => partialViewConfig),
  }))
  .mock('../Libraries/Components/View/View', () =>
    mockComponent('../Libraries/Components/View/View', MockNativeMethods),
  )
  .mock('../Libraries/Components/AccessibilityInfo/AccessibilityInfo', () => ({
    __esModule: true,
    default: {
      addEventListener: jest.fn(),
      announceForAccessibility: jest.fn(),
      announceForAccessibilityWithOptions: jest.fn(),
      isAccessibilityServiceEnabled: jest.fn(),
      isBoldTextEnabled: jest.fn(),
      isGrayscaleEnabled: jest.fn(),
      isInvertColorsEnabled: jest.fn(),
      isReduceMotionEnabled: jest.fn(),
      prefersCrossFadeTransitions: jest.fn(),
      isReduceTransparencyEnabled: jest.fn(),
      isScreenReaderEnabled: jest.fn(() => Promise.resolve(false)),
      setAccessibilityFocus: jest.fn(),
      sendAccessibilityEvent: jest.fn(),
      getRecommendedTimeoutMillis: jest.fn(),
    },
  }))
  .mock('../Libraries/Components/Clipboard/Clipboard', () => ({
    getString: jest.fn(() => ''),
    setString: jest.fn(),
  }))
  .mock('../Libraries/Components/RefreshControl/RefreshControl', () =>
    jest.requireActual(
      '../Libraries/Components/RefreshControl/__mocks__/RefreshControlMock',
    ),
  )
  .mock('../Libraries/Components/ScrollView/ScrollView', () => {
    const baseComponent = mockComponent(
      '../Libraries/Components/ScrollView/ScrollView',
      {
        ...MockNativeMethods,
        getScrollResponder: jest.fn(),
        getScrollableNode: jest.fn(),
        getInnerViewNode: jest.fn(),
        getInnerViewRef: jest.fn(),
        getNativeScrollRef: jest.fn(),
        scrollTo: jest.fn(),
        scrollToEnd: jest.fn(),
        flashScrollIndicators: jest.fn(),
        scrollResponderZoomTo: jest.fn(),
        scrollResponderScrollNativeHandleToKeyboard: jest.fn(),
      },
    );
    const mockScrollView = jest.requireActual('./mockScrollView');
    return mockScrollView(baseComponent);
  })
  // amznmod_react - Mock the ActivityIndicator and ProgressBar for kepler
  .mock('../Libraries/Components/ActivityIndicator/ActivityIndicator', () => {
      const React = require('react');
      const Component = class extends React.Component {
        render() {
          return React.createElement('View', this.props, this.props.children);
        }
      };

      Component.displayName = 'KeplerActivityIndicator';

      return {
        __esModule: true,
        default: Component,
        ActivityIndicator: Component,
      };
  })
  .mock('../Libraries/Components/ProgressBarKepler/ProgressBarKepler', () => {
      const React = require('react');
      const Component = class extends React.Component {
        render() {
          return React.createElement('View', this.props, this.props.children);
        }
      };

      Component.displayName = 'KeplerPlatformActivityIndicator';

      return {
        __esModule: true,
        default: Component,
        ProgressBarKepler: Component,
      };
  })
  .mock('../Libraries/AppState/AppState', () => ({
    addEventListener: jest.fn(() => ({
      remove: jest.fn(),
    })),
  }))
  .mock('../Libraries/Linking/Linking', () => ({
    openURL: jest.fn(),
    canOpenURL: jest.fn(() => Promise.resolve(true)),
    openSettings: jest.fn(),
    addEventListener: jest.fn(),
    getInitialURL: jest.fn(() => Promise.resolve()),
    sendIntent: jest.fn(),
  }))
  // Mock modules defined by the native layer (ex: Objective-C, Java)
  .mock('../Libraries/BatchedBridge/NativeModules', () => ({
    AlertManager: {
      alertWithArgs: jest.fn(),
    },
    AsyncLocalStorage: {
      multiGet: jest.fn((keys, callback) =>
        process.nextTick(() => callback(null, [])),
      ),
      multiSet: jest.fn((entries, callback) =>
        process.nextTick(() => callback(null)),
      ),
      multiRemove: jest.fn((keys, callback) =>
        process.nextTick(() => callback(null)),
      ),
      multiMerge: jest.fn((entries, callback) =>
        process.nextTick(() => callback(null)),
      ),
      clear: jest.fn(callback => process.nextTick(() => callback(null))),
      getAllKeys: jest.fn(callback =>
        process.nextTick(() => callback(null, [])),
      ),
    },
    DeviceInfo: {
      // amznmod_react - Mock add listener events for NativeDeviceInfo
      addListener: jest.fn(),
      getConstants() {
        // amznmod_react - Use the mock dimensions assigned at top of file
        return mockDimensions();
      },
    },
    DevSettings: {
      addMenuItem: jest.fn(),
      reload: jest.fn(),
    },
    ImageLoader: {
      getSize: jest.fn(url => Promise.resolve([320, 240])),
      prefetchImage: jest.fn(),
    },
    ImageViewManager: {
      getSize: jest.fn((uri, success) =>
        process.nextTick(() => success(320, 240)),
      ),
      prefetchImage: jest.fn(),
    },
    KeyboardObserver: {
      addListener: jest.fn(),
      removeListeners: jest.fn(),
    },
    Networking: {
      sendRequest: jest.fn(),
      abortRequest: jest.fn(),
      addListener: jest.fn(),
      removeListeners: jest.fn(),
    },
    PlatformConstants: {
      getConstants() {
        return {};
      },
    },
    PushNotificationManager: {
      presentLocalNotification: jest.fn(),
      scheduleLocalNotification: jest.fn(),
      cancelAllLocalNotifications: jest.fn(),
      removeAllDeliveredNotifications: jest.fn(),
      getDeliveredNotifications: jest.fn(callback =>
        process.nextTick(() => []),
      ),
      removeDeliveredNotifications: jest.fn(),
      setApplicationIconBadgeNumber: jest.fn(),
      getApplicationIconBadgeNumber: jest.fn(callback =>
        process.nextTick(() => callback(0)),
      ),
      cancelLocalNotifications: jest.fn(),
      getScheduledLocalNotifications: jest.fn(callback =>
        process.nextTick(() => callback()),
      ),
      requestPermissions: jest.fn(() =>
        Promise.resolve({alert: true, badge: true, sound: true}),
      ),
      abandonPermissions: jest.fn(),
      checkPermissions: jest.fn(callback =>
        process.nextTick(() =>
          callback({alert: true, badge: true, sound: true}),
        ),
      ),
      getInitialNotification: jest.fn(() => Promise.resolve(null)),
      addListener: jest.fn(),
      removeListeners: jest.fn(),
    },
    SourceCode: {
      getConstants() {
        return {
          scriptURL: null,
        };
      },
    },
    StatusBarManager: {
      setColor: jest.fn(),
      setStyle: jest.fn(),
      setHidden: jest.fn(),
      setNetworkActivityIndicatorVisible: jest.fn(),
      setBackgroundColor: jest.fn(),
      setTranslucent: jest.fn(),
      getConstants: () => ({
        HEIGHT: 42,
      }),
    },
    Timing: {
      createTimer: jest.fn(),
      deleteTimer: jest.fn(),
    },
    UIManager: {},
    BlobModule: {
      getConstants: () => ({BLOB_URI_SCHEME: 'content', BLOB_URI_HOST: null}),
      addNetworkingHandler: jest.fn(),
      enableBlobSupport: jest.fn(),
      disableBlobSupport: jest.fn(),
      createFromParts: jest.fn(),
      sendBlob: jest.fn(),
      release: jest.fn(),
    },
    WebSocketModule: {
      connect: jest.fn(),
      send: jest.fn(),
      sendBinary: jest.fn(),
      ping: jest.fn(),
      close: jest.fn(),
      addListener: jest.fn(),
      removeListeners: jest.fn(),
    },
    I18nManager: {
      allowRTL: jest.fn(),
      forceRTL: jest.fn(),
      swapLeftAndRightInRTL: jest.fn(),
      addListener: jest.fn(),
      removeListeners: jest.fn(),
      getAppLocale: jest.fn(),
      setAppLocale: jest.fn(),
      getTimezone: jest.fn(),
      setTimezone: jest.fn(),
      getConstants: () => ({
        isRTL: false,
        doLeftAndRightSwapInRTL: true,
      }),
    },
  }))
  .mock('../Libraries/NativeComponent/NativeComponentRegistry', () => {
    return {
      get: jest.fn((name, viewConfigProvider) => {
        return jest.requireActual('./mockNativeComponent').default(name);
      }),
      getWithFallback_DEPRECATED: jest.fn((name, viewConfigProvider) => {
        return jest.requireActual('./mockNativeComponent').default(name);
      }),
      setRuntimeConfigProvider: jest.fn(),
    };
  })
  .mock('../Libraries/ReactNative/requireNativeComponent', () => {
    return jest.requireActual('./mockNativeComponent');
  })
  // amznmod_react - Mock native device info, return mockDimensions
  .mock('../Libraries/Utilities/NativeDeviceInfo', () => ({
    __esModule: true,
    default: {
      addEventListener: jest.fn(),
      addListenerV2: jest.fn(),
      getConstants: () => {
        return mockDimensions();
      },
      getDimensionsV2: () => {
        return {
          Dimensions: {
            width: -1,
            height: -1,
            scale: 1,
            fontScale: 1,
            moduleName: 'MockDisplayMetrics',
          }
        };
      },
    }
  }))
  .mock('../Libraries/KeplerAppState/KeplerAppStateManager', () => ({
    useComponentInstance: () => jest.fn(),
    useAddEventListenerWithReplayCallback: () => jest.fn(),
    useAddKeplerAppStateListenerWithReplayCallback: () => jest.fn(),
    useAddKeplerAppStateListenerCallback: () => jest.fn(),
    useGetCurrentKeplerAppStateCallback: () => 'unknown',
}))
  // amznmod_react - Mock Dimensions, return mockDimensions
  .mock('../Libraries/Utilities/Dimensions', () => ({
    default: {
      get: (dimensionType: string) => mockDimensions().Dimensions[dimensionType],
      set: jest.fn(),
      addEventListener: jest.fn(),
      addEventListenerV2: jest.fn(),
      useWindowDimensions: jest.fn(() => {
          return {
            width: 960,
            height: 480,
            scale: 1,
            fontScale: 1,
          };
      }),
    },
  }))
  // amznmod_react - Mock BackHandler
  .mock('../Libraries/Utilities/BackHandler', () => ({
      addEventListener: jest.fn(),
      removeEventListener: jest.fn(),
      exitApp: jest.fn(),
  }))
  // amznmod_react - Mock NativePlatformConstantsKepler
  .mock('../Libraries/Utilities/NativePlatformConstantsKepler', () => {
    return {
      getConstants: () => {
        return {
          isTesting: true,
          reactNativeVersion: {
            major: '42',
            minor: '42',
            patch: '42',
          },
          Version: 42,
          Release: 'jest-testing-release-string',
          Serial: 'mock-serial',
          Fingerprint: 'mock-finger-print',
          Model: 'mock-device-model',
          ServerHost: 'mock-server-host',
          uiMode: 'mock-ui-mode',
          Brand: 'mock-device-brand',
          Manufacturer: 'mock-device-manufacturer',
        };
      },
    };
  })
  .mock(
    '../Libraries/Utilities/verifyComponentAttributeEquivalence',
    () => function () {},
  )
  .mock('../Libraries/Vibration/Vibration', () => ({
    vibrate: jest.fn(),
    cancel: jest.fn(),
  }))
  .mock('../Libraries/Components/View/ViewNativeComponent', () => {
    const React = require('react');
    const Component = class extends React.Component {
      render() {
        return React.createElement('View', this.props, this.props.children);
      }
    };

    Component.displayName = 'View';

    return {
      __esModule: true,
      default: Component,
    };
  });

"use strict";
/*
 * Copyright 2025 Amazon.com, Inc. or its affiliates. All rights reserved.
 *
 * AMAZON PROPRIETARY/CONFIDENTIAL
 *
 * You may not use this file except in compliance with the terms and
 * conditions set forth in the accompanying LICENSE.TXT file.
 *
 * THESE MATERIALS ARE PROVIDED ON AN "AS IS" BASIS. AMAZON SPECIFICALLY
 * DISCLAIMS, WITH RESPECT TO THESE MATERIALS, ALL WARRANTIES, EXPRESS,
 * IMPLIED, OR STATUTORY, INCLUDING THE IMPLIED WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, AND NON-INFRINGEMENT.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.checkEncryptedDecodingsupport = void 0;
const EncryptedMediaImpl_1 = require("./EncryptedMediaImpl");
const LogUtils_1 = require("./LogUtils");
const knownRobustnessLevels = ["SECURE", "NON-SECURE", "HW_SECURE_ALL", "SW_SECURE_CRYPTO", "SW_SECURE_DECODE", "HW_SECURE_CRYPTO", "HW_SECURE_DECODE", "2000", "3000", "150"];
/**
 * Given a @type {MediaDecodingConfiguration} where @type {keySystemConfiguration}
 * exists, this algorithm returns a @type {MediaKeySystemAccess} or null as appropriate.
 * @param config @type {MediaDecodingConfiguration}
 * @returns @type {MediaKeySystemAccess} or null
 */
async function checkEncryptedDecodingsupport(config) {
    LogUtils_1.LogUtil.debug("checkEncryptedDecodingsupport++");
    // https://www.w3.org/TR/media-capabilities/#check-encrypted-decoding-support
    if (!config.keySystemConfiguration) {
        LogUtils_1.LogUtil.error("checkEncryptedDecodingsupport: keySystemConfiguration is null");
        return null;
    }
    // 1. If the keySystem member of config.keySystemConfiguration is not one of the Key Systems
    //    supported by the user agent, return null. String comparison is case-sensitive.
    // Note: we are not checking this here, but when we call the requestMediaKeySystemAccess fn
    // 2. Let origin be the origin of the calling contextâ€™s Document.
    // TODO: should we really do this?
    // 3. Let implementation be the implementation of config.keySystemConfiguration.keySystem
    // TODO: Is this applicable for us?
    // 4. Let emeConfiguration be a new MediaKeySystemConfiguration, and initialize it as follows:
    let emeConfiguration = {};
    // 4.1 Set the initDataTypes attribute to a sequence containing config.keySystemConfiguration.initDataType.
    emeConfiguration.initDataTypes = [config.keySystemConfiguration.initDataType];
    // 4.2 Set the distinctiveIdentifier attribute to config.keySystemConfiguration.distinctiveIdentifier.
    emeConfiguration.distinctiveIdentifier = config.keySystemConfiguration.distinctiveIdentifier;
    // 4.3  Set the persistentState attribute to config.keySystemConfiguration.persistentState.
    emeConfiguration.persistentState = config.keySystemConfiguration.persistentState;
    // 4.4  Set the sessionTypes attribute to config.keySystemConfiguration.sessionTypes.
    emeConfiguration.sessionTypes = [];
    for (let index = 0; index < config.keySystemConfiguration.sessionTypes.length; index++) {
        const typeStr = config.keySystemConfiguration.sessionTypes[index];
        if (typeStr === "temporary" || typeStr === "persistent-license") {
            emeConfiguration.sessionTypes.push(typeStr);
        }
    }
    // 4.5  If audio exists in config, set the audioCapabilities attribute to a sequence containing a
    //      single MediaKeySystemMediaCapability, initialized as follows:
    if (config.audio !== undefined) {
        LogUtils_1.LogUtil.debug("audio is valid");
        let keyCap = {
            contentType: "",
            robustness: "NON-SECURE"
        };
        // 4.5.1  Set the contentType attribute to config.audio.contentType.
        keyCap.contentType = config.audio.contentType;
        LogUtils_1.LogUtil.debug("config.keySystemConfiguration.audio is ", config.keySystemConfiguration.audio);
        //  4.5.2 If config.keySystemConfiguration.audio exists:
        if (config.keySystemConfiguration.audio !== undefined) {
            // 4.5.2.1 Set the robustness attribute to config.keySystemConfiguration.audio.robustness
            let audioRobustness = config.keySystemConfiguration.audio.robustness;
            if (knownRobustnessLevels.includes(audioRobustness)) {
                keyCap.robustness = audioRobustness;
            }
            // 4.5.2.2 Set the encryptionScheme attribute to config.keySystemConfiguration.audio.encryptionScheme
            keyCap.encryptionScheme = config.keySystemConfiguration.audio.encryptionScheme;
        }
        emeConfiguration.audioCapabilities = [keyCap];
    }
    // 4.6  If video exists in config, set the videoCapabilities attribute to a sequence containing a
    //      single MediaKeySystemMediaCapability, initialized as follows:
    if (config.video !== undefined) {
        let keyCap = {
            contentType: "",
            robustness: "NON-SECURE"
        };
        // 4.6.1  Set the contentType attribute to config.video.contentType.
        keyCap.contentType = config.video.contentType;
        LogUtils_1.LogUtil.debug("config.keySystemConfiguration.video is ", config.keySystemConfiguration.video);
        // 4.6.2  If config.keySystemConfiguration.video exists:
        if (config.keySystemConfiguration.video !== undefined) {
            // 4.6.2.1  Set the robustness attribute to config.keySystemConfiguration.video.robustness.
            let videoRobustness = config.keySystemConfiguration.video.robustness;
            if (knownRobustnessLevels.includes(videoRobustness)) {
                keyCap.robustness = videoRobustness;
            }
        }
        emeConfiguration.videoCapabilities = [keyCap];
    }
    let keySystemAccess = null;
    try {
        keySystemAccess = await (0, EncryptedMediaImpl_1.requestMediaKeySystemAccess)(config.keySystemConfiguration.keySystem, [emeConfiguration]);
    }
    catch (e) {
        LogUtils_1.LogUtil.error('requestMediaKeySystemAccess failed.');
    }
    LogUtils_1.LogUtil.debug("checkEncryptedDecodingsupport-- ");
    return keySystemAccess;
}
exports.checkEncryptedDecodingsupport = checkEncryptedDecodingsupport;
